- name: dcos-download.service
  content: |
    [Unit]
    Description=Pkgpanda: Download DC/OS to this host.
    After=network-online.target
    Wants=network-online.target
    ConditionPathExists=!c:\opt\mesosphere\active\
    [Service]
    Type=oneshot
    StandardOutput=journal+console
    StandardError=journal+console
    ExecStartPre=cmd.exe /c mkdir c:\tmp
    ExecStartPre=curl.exe --keepalive-time 2 -fLsSv --retry 20 -Y 100000 -y 60 -o c:\{{ bootstrap_tmp_dir }}\bootstrap.tar.xz {{ bootstrap_url }}/bootstrap/{{ bootstrap_id }}.bootstrap.tar.xz
    ExecStartPre=cmd.exe /c mkdir c:\opt\mesosphere
    ExecStart=7z e c:\{{ bootstrap_tmp_dir }}\bootstrap.tar.xz -oc:\bootstrap_tmp_dir
    ExecStart=7z x c:\{{ bootstrap_tmp_dir }}\bootstrap.tar -oc:\opt\mesosphere
    ExecStartPost=-cmd.exe /c del /f c:\{{ bootstrap_tmp_dir }}\bootstrap.tar.xz
    ExecStartPost=-cmd.exe /c del /f c:\{{ bootstrap_tmp_dir }}\bootstrap.tar
- name: dcos-setup.service
  command: start
  no_block: true
  enable: true
  content: |
    [Unit]
    Description=Pkgpanda: Specialize DC/OS for this host.
    Requires=dcos-download.service
    After=dcos-download.service
    [Service]
    Type=oneshot
    StandardOutput=journal+console
    StandardError=journal+console
    EnvironmentFile=c:\opt\mesosphere\environment
    ExecStart=c:\opt\mesosphere\bin\scripts\pkgpanda setup --no-block-systemd
    [Install]
    WantedBy=multi-user.target
